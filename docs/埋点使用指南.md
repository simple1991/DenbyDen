# ğŸ“Š åŸ‹ç‚¹ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
2. [æ•°æ®åº“è®¾ç½®](#æ•°æ®åº“è®¾ç½®)
3. [åœ¨ç»„ä»¶ä¸­ä½¿ç”¨åŸ‹ç‚¹](#åœ¨ç»„ä»¶ä¸­ä½¿ç”¨åŸ‹ç‚¹)
4. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)

---

## ç¯å¢ƒé…ç½®

### 1. å®‰è£…ä¾èµ–

```bash
npm install @supabase/supabase-js
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env.local` æ–‡ä»¶ï¼š

```env
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2aWFlbGFjZGxmYXJrcGJneHBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NDY0NzcsImV4cCI6MjA3OTEyMjQ3N30.p199voR5rSx8vFGWXyNTVx835p6xbv7Eb_5I1sQ8Gv8
```

**æ³¨æ„**ï¼šå¦‚æœä¸æƒ³ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œ`lib/supabase.ts` ä¸­å·²ç»ç¡¬ç¼–ç äº† API Keyï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

---

## æ•°æ®åº“è®¾ç½®

### 1. ç™»å½• Supabase Dashboard

è®¿é—®ï¼šhttps://supabase.com/dashboard

### 2. é€‰æ‹©é¡¹ç›®

é€‰æ‹©ä½ çš„é¡¹ç›®ï¼š`yviaelacdlfarkpbgxps`

### 3. æ‰§è¡Œ SQL è„šæœ¬

1. è¿›å…¥ **SQL Editor**
2. ç‚¹å‡» **New Query**
3. å¤åˆ¶ `docs/supabase_schema.sql` æ–‡ä»¶ä¸­çš„å†…å®¹
4. ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­
5. ç‚¹å‡» **Run** æ‰§è¡Œ

### 4. éªŒè¯è¡¨ç»“æ„

æ‰§è¡Œåï¼Œåœ¨ **Table Editor** ä¸­åº”è¯¥èƒ½çœ‹åˆ°ä»¥ä¸‹è¡¨ï¼š
- `events`
- `product_exposures`
- `product_clicks`
- `cart_actions`
- `email_captures`
- `page_interactions`
- `page_dwell_time`

---

## åœ¨ç»„ä»¶ä¸­ä½¿ç”¨åŸ‹ç‚¹

### 1. äº§å“å¡ç‰‡æ›å…‰

åœ¨ `ProductCard` ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```typescript
import { useProductExposure } from '@/hooks/useAnalytics'

export default function ProductCard({ product, position, listType, pageType }) {
  const elementRef = useProductExposure(
    product.id,
    product.slug,
    position,
    listType,
    pageType
  )

  return (
    <div ref={elementRef} className="card">
      {/* äº§å“å†…å®¹ */}
    </div>
  )
}
```

### 2. äº§å“ç‚¹å‡»

```typescript
import { useProductClick } from '@/hooks/useAnalytics'

export default function ProductCard({ product, position, pageType }) {
  const handleClick = useProductClick(
    product.id,
    product.slug,
    position,
    'card_click',
    pageType
  )

  return (
    <Link href={`/product/${product.slug}`} onClick={handleClick}>
      {/* äº§å“å†…å®¹ */}
    </Link>
  )
}
```

### 3. åŠ å…¥è´­ç‰©è½¦

```typescript
import { useAddToCart } from '@/hooks/useAnalytics'

export default function ProductCard({ product, position }) {
  const handleAddToCart = useAddToCart(
    product.id,
    product.slug,
    1,
    product.price,
    null, // variant
    false, // giftWrapping
    position
  )

  return (
    <button onClick={handleAddToCart}>
      Add to Cart
    </button>
  )
}
```

### 4. é‚®ç®±æäº¤

```typescript
import { useEmailSubmit } from '@/hooks/useAnalytics'

export default function EmailCaptureModal({ isOpen, onClose }) {
  const handleEmailSubmit = useEmailSubmit('home')

  const handleSubmit = async (email: string) => {
    // ä½ çš„æäº¤é€»è¾‘
    await submitEmail(email)
    
    // åŸ‹ç‚¹
    handleEmailSubmit(email)
  }

  return (
    <form onSubmit={(e) => {
      e.preventDefault()
      handleSubmit(email)
    }}>
      {/* è¡¨å•å†…å®¹ */}
    </form>
  )
}
```

### 5. é¡µé¢åœç•™æ—¶é•¿

åœ¨é¡µé¢ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```typescript
import { usePageDwell } from '@/hooks/useAnalytics'

export default function HomePage() {
  usePageDwell('home')
  
  return (
    <div>
      {/* é¡µé¢å†…å®¹ */}
    </div>
  )
}
```

### 6. äº§å“è¯¦æƒ…é¡µæŸ¥çœ‹

```typescript
import { useProductDetailView } from '@/hooks/useAnalytics'

export default function ProductPage({ product }) {
  useProductDetailView(product.id, product.slug)
  
  return (
    <div>
      {/* äº§å“è¯¦æƒ… */}
    </div>
  )
}
```

### 7. å›¾ç‰‡æ»‘åŠ¨

```typescript
import { useImageSwipe } from '@/hooks/useAnalytics'

export default function ProductGallery({ product, images }) {
  const handleSwipe = useImageSwipe(product.id, images.length)

  return (
    <div>
      {images.map((img, idx) => (
        <button onClick={() => handleSwipe(idx)}>
          {/* ç¼©ç•¥å›¾ */}
        </button>
      ))}
    </div>
  )
}
```

### 8. æŠ˜å åŒºå±•å¼€

```typescript
import { useSectionExpand } from '@/hooks/useAnalytics'

export default function CollapsibleSection({ title, productId }) {
  const handleExpand = useSectionExpand(productId)

  return (
    <button onClick={() => {
      setIsOpen(!isOpen)
      if (!isOpen) {
        handleExpand(title)
      }
    }}>
      {title}
    </button>
  )
}
```

### 9. æ»šåŠ¨æ·±åº¦

```typescript
import { useScrollDepth } from '@/hooks/useAnalytics'

export default function ShopPage() {
  useScrollDepth('shop')
  
  return (
    <div>
      {/* é¡µé¢å†…å®¹ */}
    </div>
  )
}
```

---

## å®Œæ•´ç¤ºä¾‹

### é¦–é¡µé›†æˆç¤ºä¾‹

```typescript
'use client'

import { usePageDwell, useScrollDepth } from '@/hooks/useAnalytics'
import ProductCard from '@/components/ProductCard'

export default function HomePage() {
  // é¡µé¢åœç•™æ—¶é•¿
  usePageDwell('home')
  
  // æ»šåŠ¨æ·±åº¦
  useScrollDepth('home')

  const products = getProducts()

  return (
    <div>
      <ProductGrid
        products={products}
        listType="new_arrivals"
        pageType="home"
      />
    </div>
  )
}
```

### ProductCard å®Œæ•´ç¤ºä¾‹

```typescript
'use client'

import { useRef } from 'react'
import { useProductExposure, useProductClick, useAddToCart } from '@/hooks/useAnalytics'
import Link from 'next/link'

export default function ProductCard({ product, position, listType, pageType }) {
  // äº§å“æ›å…‰
  const elementRef = useProductExposure(
    product.id,
    product.slug,
    position,
    listType,
    pageType
  )

  // äº§å“ç‚¹å‡»
  const handleCardClick = useProductClick(
    product.id,
    product.slug,
    position,
    'card_click',
    pageType
  )

  // åŠ å…¥è´­ç‰©è½¦
  const handleAddToCart = useAddToCart(
    product.id,
    product.slug,
    1,
    product.price,
    null,
    false,
    position
  )

  return (
    <div ref={elementRef} className="card">
      <Link href={`/product/${product.slug}`} onClick={handleCardClick}>
        <Image src={product.image} alt={product.title} />
        <h3>{product.title}</h3>
      </Link>
      
      <button onClick={handleAddToCart}>
        Add to Cart
      </button>
    </div>
  )
}
```

### äº§å“è¯¦æƒ…é¡µå®Œæ•´ç¤ºä¾‹

```typescript
'use client'

import { useState } from 'react'
import {
  useProductDetailView,
  useImageSwipe,
  useSectionExpand,
  useGiftWrappingToggle,
  useAddToCart,
  usePageDwell,
} from '@/hooks/useAnalytics'

export default function ProductDetailPage({ product }) {
  const [selectedImageIndex, setSelectedImageIndex] = useState(0)
  const [giftWrapping, setGiftWrapping] = useState(false)
  const [quantity, setQuantity] = useState(1)

  // äº§å“è¯¦æƒ…é¡µæŸ¥çœ‹
  useProductDetailView(product.id, product.slug)

  // é¡µé¢åœç•™æ—¶é•¿
  usePageDwell('product_detail', product.id)

  // å›¾ç‰‡æ»‘åŠ¨
  const handleImageSwipe = useImageSwipe(product.id, product.images.length)

  // æŠ˜å åŒºå±•å¼€
  const handleSectionExpand = useSectionExpand(product.id)

  // ç¤¼å“åŒ…è£…åˆ‡æ¢
  const handleGiftWrappingToggle = useGiftWrappingToggle(product.id)

  // åŠ å…¥è´­ç‰©è½¦
  const handleAddToCart = useAddToCart(
    product.id,
    product.slug,
    quantity,
    product.price,
    null,
    giftWrapping
  )

  return (
    <div>
      {/* å›¾ç‰‡ç”»å»Š */}
      <div>
        {product.images.map((img, idx) => (
          <button
            onClick={() => {
              setSelectedImageIndex(idx)
              handleImageSwipe(idx)
            }}
          >
            {/* ç¼©ç•¥å›¾ */}
          </button>
        ))}
      </div>

      {/* æŠ˜å åŒº */}
      <CollapsibleSection
        title="DETAILS"
        onExpand={() => handleSectionExpand('DETAILS')}
      />

      {/* ç¤¼å“åŒ…è£… */}
      <button
        onClick={() => {
          setGiftWrapping(!giftWrapping)
          handleGiftWrappingToggle(!giftWrapping)
        }}
      >
        Gift Wrapping
      </button>

      {/* åŠ å…¥è´­ç‰©è½¦ */}
      <button onClick={handleAddToCart}>
        Add to Cart
      </button>
    </div>
  )
}
```

---

## æ•°æ®æŸ¥çœ‹

### åœ¨ Supabase Dashboard ä¸­æŸ¥çœ‹æ•°æ®

1. è¿›å…¥ **Table Editor**
2. é€‰æ‹©è¡¨ï¼ˆå¦‚ `events`ï¼‰
3. æŸ¥çœ‹å®æ—¶æ•°æ®

### å¸¸ç”¨æŸ¥è¯¢

#### æŸ¥çœ‹ä»Šæ—¥äº‹ä»¶æ•°
```sql
SELECT COUNT(*) 
FROM events 
WHERE DATE(timestamp) = CURRENT_DATE;
```

#### æŸ¥çœ‹äº§å“æ›å…‰æ’è¡Œ
```sql
SELECT 
  product_id,
  COUNT(*) as exposure_count
FROM product_exposures
WHERE DATE(created_at) = CURRENT_DATE
GROUP BY product_id
ORDER BY exposure_count DESC
LIMIT 10;
```

#### æŸ¥çœ‹è½¬åŒ–æ¼æ–—
```sql
SELECT 
  e.event_type,
  COUNT(*) as count
FROM events e
WHERE DATE(e.timestamp) = CURRENT_DATE
  AND e.event_type IN ('product_exposure', 'product_click', 'add_to_cart')
GROUP BY e.event_type
ORDER BY 
  CASE e.event_type
    WHEN 'product_exposure' THEN 1
    WHEN 'product_click' THEN 2
    WHEN 'add_to_cart' THEN 3
  END;
```

---

## æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ›å…‰ç±»äº‹ä»¶ä½¿ç”¨æ‰¹é‡ä¸ŠæŠ¥ï¼Œä¸ä¼šå½±å“é¡µé¢æ€§èƒ½
2. **é”™è¯¯å¤„ç†**ï¼šç½‘ç»œé”™è¯¯æ—¶æ•°æ®ä¼šæš‚å­˜åˆ°é˜Ÿåˆ—ï¼Œé¡µé¢é‡æ–°åŠ è½½æ—¶è‡ªåŠ¨é‡è¯•
3. **éšç§ä¿æŠ¤**ï¼šä¸æ”¶é›†ç”¨æˆ·IPå’Œæ•æ„Ÿä¿¡æ¯
4. **æ•°æ®å»é‡**ï¼šåŒä¸€äº§å“åŒä¸€ä½ç½®çš„æ›å…‰åœ¨5ç§’å†…åªä¸ŠæŠ¥ä¸€æ¬¡

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ•°æ®æ²¡æœ‰ä¸ŠæŠ¥

1. æ£€æŸ¥ Supabase è¿æ¥æ˜¯å¦æ­£å¸¸
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
3. æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®è®¾ç½®

### é—®é¢˜ï¼šé‡å¤ä¸ŠæŠ¥

1. æ£€æŸ¥æ˜¯å¦åœ¨å¤šä¸ªåœ°æ–¹è°ƒç”¨äº†åŒä¸€ä¸ª Hook
2. æ£€æŸ¥ `hasTracked` çŠ¶æ€æ˜¯å¦æ­£ç¡®

### é—®é¢˜ï¼šæ•°æ®å»¶è¿Ÿ

1. æ›å…‰ç±»äº‹ä»¶ä½¿ç”¨æ‰¹é‡ä¸ŠæŠ¥ï¼Œæœ€å¤šå»¶è¿Ÿ5ç§’
2. å…³é”®äº‹ä»¶ï¼ˆå¦‚åŠ è´­ï¼‰ä¼šç«‹å³ä¸ŠæŠ¥

